# Test scenarios for EVSE distribution
# Each scenario tests specific conditions

scenarios:
  # ===== SINGLE PHASE SCENARIOS =====
  
  - name: "1ph-1charger-solar-with-battery"
    description: "Single phase, 1 charger, solar mode, with battery"
    site:
      voltage: 230
      num_phases: 1
      total_export_current: 15.0  # 15A export available
      battery_soc: 75
      battery_soc_min: 20
      battery_soc_target: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 1
        mode: "Solar"
        priority: 1
    expected:
      charger_1:
        target: 15.0  # Gets all 15A
  
  - name: "1ph-1charger-solar-no-battery"
    description: "Single phase, 1 charger, solar mode, no battery"
    site:
      voltage: 230
      num_phases: 1
      total_export_current: 8.0
      battery_soc: null
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 1
        mode: "Solar"
    expected:
      charger_1:
        target: 8.0
  
  - name: "1ph-1charger-insufficient-solar"
    description: "Single phase, insufficient solar (below min)"
    site:
      voltage: 230
      total_export_current: 4.0  # Below 6A min
      battery_soc: null
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 1
        mode: "Solar"
    expected:
      charger_1:
        target: 0  # Below minimum
  
  - name: "1ph-2chargers-solar-double-count-check"
    description: "Single phase, 2 chargers both solar - verify no double counting"
    site:
      voltage: 230
      total_export_current: 20.0
      battery_soc: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 1
        mode: "Solar"
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 1
        mode: "Solar"
        priority: 2
    expected:
      charger_1:
        target: 16  # Limited by max, not 20A
      charger_2:
        target: 16  # Both see same 20A resource
  
  # ===== THREE PHASE SCENARIOS =====
  
  - name: "3ph-1charger-solar-with-battery"
    description: "3-phase, 1 charger, solar mode, with battery"
    site:
      voltage: 230
      num_phases: 3
      total_export_current: 30.0  # 30A total = 10A per phase
      battery_soc: 75
      battery_soc_min: 20
      battery_soc_target: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Solar"
    expected:
      charger_1:
        target: 10.0  # 30A / 3 phases = 10A per phase
  
  - name: "3ph-2chargers-solar-shared"
    description: "3-phase, 2 chargers, both solar - should share same resource"
    site:
      voltage: 230
      total_export_current: 24.0  # 24A total = 8A per phase
      battery_soc: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Solar"
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Solar"
        priority: 2
    expected:
      charger_1:
        target: 8.0  # Both see 24/3 = 8A per phase
      charger_2:
        target: 8.0
  
  - name: "3ph-2chargers-mixed-modes"
    description: "3-phase, Standard + Solar modes"
    site:
      voltage: 230
      total_export_current: 18.0  # 6A per phase
      battery_soc: 85
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 32
        phases: 3
        mode: "Standard"
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Solar"
        priority: 2
    expected:
      charger_1:
        target: 32  # Wants max
      charger_2:
        target: 6.0  # Gets 18/3 = 6A (exactly min)
  
  # ===== ECO MODE SCENARIOS =====
  
  - name: "3ph-eco-battery-above-target"
    description: "Eco mode with battery above target"
    site:
      voltage: 230
      total_export_current: 12.0
      battery_soc: 85  # Above 80% target
      battery_soc_min: 20
      battery_soc_target: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Eco"
    expected:
      charger_1:
        target: 16  # Battery above target = full speed
  
  - name: "3ph-eco-battery-below-min"
    description: "Eco mode with battery below minimum"
    site:
      voltage: 230
      total_export_current: 20.0
      battery_soc: 15  # Below 20% min
      battery_soc_min: 20
      battery_soc_target: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Eco"
    expected:
      charger_1:
        target: 0  # Battery too low = no charging
  
  - name: "3ph-eco-battery-between"
    description: "Eco mode with battery between min and target"
    site:
      voltage: 230
      total_export_current: 15.0  # 5A per phase
      battery_soc: 50  # Between 20-80%
      battery_soc_min: 20
      battery_soc_target: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Eco"
    expected:
      charger_1:
        target: 6  # Uses min_current (export=5A < min=6A)
  
  # ===== EXCESS MODE SCENARIOS =====
  
  - name: "3ph-excess-above-threshold"
    description: "Excess mode with export above threshold"
    site:
      voltage: 230
      total_export_power: 15000  # 15kW
      excess_export_threshold: 10000  # 10kW
      battery_soc: 85
      battery_soc_target: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Excess"
    expected:
      charger_1:
        target: 7.2  # (15000-10000)/230/3 = 7.25A
  
  - name: "3ph-excess-below-threshold"
    description: "Excess mode with export below threshold"
    site:
      voltage: 230
      total_export_power: 8000  # 8kW
      excess_export_threshold: 10000
      battery_soc: 85
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Excess"
    expected:
      charger_1:
        target: 0  # Below threshold
  
  # ===== MULTI-CHARGER SCENARIOS =====
  
  - name: "3ph-3chargers-standard"
    description: "3 chargers, all standard mode"
    site:
      voltage: 230
      total_export_current: 40.0
      battery_soc: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Standard"
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Standard"
        priority: 2
      - entity_id: "charger_3"
        min_current: 6
        max_current: 10
        phases: 3
        mode: "Standard"
        priority: 3
    expected:
      charger_1:
        target: 16
      charger_2:
        target: 16
      charger_3:
        target: 10
  
  - name: "3ph-mixed-1ph-and-3ph-chargers"
    description: "Mix of 1-phase and 3-phase chargers"
    site:
      voltage: 230
      total_export_current: 30.0
      battery_soc: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Solar"
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 1  # Single phase charger
        mode: "Solar"
        priority: 2
    expected:
      charger_1:
        target: 10.0  # 30A / 3ph = 10A
      charger_2:
        target: 16  # Sees full 30A but limited by max=16A
  
  # ===== NO BATTERY SCENARIOS =====
  
  - name: "3ph-no-battery-solar"
    description: "Solar mode without battery configured"
    site:
      voltage: 230
      total_export_current: 21.0
      battery_soc: null  # No battery
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Solar"
    expected:
      charger_1:
        target: 7.0  # 21/3 = 7A
  
  - name: "3ph-no-battery-eco"
    description: "Eco mode without battery - should use export"
    site:
      voltage: 230
      total_export_current: 24.0
      battery_soc: null
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Eco"
    expected:
      charger_1:
        target: 8.0  # 24/3 = 8A (no battery = uses export)
  
  # ===== EDGE CASES =====
  
  - name: "3ph-no-export-available"
    description: "No solar export available"
    site:
      voltage: 230
      total_export_current: 0
      battery_soc: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Solar"
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Standard"
    expected:
      charger_1:
        target: 0  # No export
      charger_2:
        target: 16  # Standard wants max
  
  - name: "3ph-import-scenario"
    description: "Site importing (negative export)"
    site:
      voltage: 230
      total_export_current: -10.0  # Importing
      battery_soc: 80
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        mode: "Solar"
    expected:
      charger_1:
        target: 0  # No export = no charging
