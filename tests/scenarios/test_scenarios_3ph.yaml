# Extended test scenarios for EVSE distribution
# These test additional edge cases and scenarios not covered in main test suite

scenarios:
  # ===== INVERTER LIMIT EDGE CASES =====
  
  - name: "3ph-1c-solar-asym-per-phase-limit-hit"
    description: "Per-phase inverter limit constrains available power"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 16000  # ~70A total, ~23A per phase
      phase_a_consumption: 0.5
      phase_b_consumption: 0.5
      phase_c_consumption: 0.5
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 5000
      battery_max_discharge_power: 5000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 4000  # 17.4A per phase limit
      inverter_max_power: 20000  # 87A total limit
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 32
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 17.4  # Limited by per-phase, not total
  
  - name: "3ph-1c-solar-asym-total-limit-hit"
    description: "Total inverter limit constrains available power"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 16000  # ~70A total
      phase_a_consumption: 0.5
      phase_b_consumption: 0.5
      phase_c_consumption: 0.5
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 5000
      battery_max_discharge_power: 5000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 8000  # 34.8A per phase (high)
      inverter_max_power: 12000  # 52.2A total limit (constraining)
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 32
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 17.4  # (12000W / 230V) / 3 phases = 17.4A per phase
  
  # ===== DISTRIBUTION MODE TESTS =====
  
  - name: "3ph-3c-solar-strict-distribution"
    description: "Strict mode: Sequential allocation"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: strict
      charging_mode: Solar
      solar_production: 12000  # 52A total
      phase_a_consumption: 1.0
      phase_b_consumption: 1.0
      phase_c_consumption: 1.0
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 8000
      inverter_max_power: 20000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 2
      - entity_id: "charger_3"
        min_current: 6
        max_current: 10
        phases: 3
        priority: 3
    expected:
      charger_1:
        target: 16  # Gets full 16A
      charger_2:
        target: 0.3  # Gets remaining (49A - 48A = 1A total = 0.3A per phase)
      charger_3:
        target: 0  # Nothing left
  
  - name: "3ph-3c-solar-optimized-distribution"
    description: "Optimized mode: Smart reduction to fit more chargers"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: optimized
      charging_mode: Solar
      solar_production: 9000  # 39A total
      phase_a_consumption: 1.0
      phase_b_consumption: 1.0
      phase_c_consumption: 1.0
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 8000
      inverter_max_power: 20000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 2
      - entity_id: "charger_3"
        min_current: 6
        max_current: 10
        phases: 3
        priority: 3
    expected:
      charger_1:
        target: 6  # Reduced to allow others
      charger_2:
        target: 6  # Gets minimum
      charger_3:
        target: 0  # Not enough for all 3
  
  # ===== COMPLEX MIXED-PHASE SCENARIOS =====
  
  - name: "3ph-3c-solar-asym-triple-mixed"
    description: "Three chargers: 1ph + 1ph + 3ph with asymmetric inverter"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 15000  # 65A total
      phase_a_consumption: 2.0
      phase_b_consumption: 1.5
      phase_c_consumption: 1.5
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 5000
      battery_max_discharge_power: 5000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 8000
      inverter_max_power: 20000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 2
      - entity_id: "charger_3"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 3
    expected:
      charger_1:
        target: 16  # 48A consumed
      charger_2:
        target: 7  # 7A consumed
      charger_3:
        target: 0  # 60A - 48A - 7A = 5A left (below min)
  
  - name: "3ph-2c-solar-sym-two-single-phase"
    description: "Two 1-phase chargers on different phases, symmetric system"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 12000  # 52A total, 17.4A per phase
      phase_a_consumption: 2.0
      phase_b_consumption: 1.0
      phase_c_consumption: 1.0
      battery_soc: null
      battery_soc_min: null
      battery_soc_target: null
      battery_max_charge_power: null
      battery_max_discharge_power: null
      inverter_supports_asymmetric: false
      inverter_max_power_per_phase: 8000
      inverter_max_power: 20000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 1
        connected_to_phase: "A"
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 1
        connected_to_phase: "B"
        priority: 2
    expected:
      charger_1:
        target: 15.4  # Phase A: 17.4A - 2A = 15.4A
      charger_2:
        target: 16  # Phase B: 17.4A - 1A = 16.4A (limited to max 16A)
  
  # ===== GRID CHARGING PERMISSION TESTS =====
  
  - name: "3ph-1c-solar-no-grid-charging-with-bat"
    description: "allow_grid_charging=False limits to export only"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      allow_grid_charging: false
      solar_production: 3000  # 13A total
      phase_a_consumption: 3.0
      phase_b_consumption: 3.0
      phase_c_consumption: 3.0  # 9A total, 4A export
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 6000
      inverter_max_power: 15000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 6.0  # Limited to export (4A) + battery (17.4A) = 21.4A total / 3 = 7.1A, but battery can add

  - name: "3ph-1c-eco-no-grid-low-battery"
    description: "No grid charging with battery below minimum"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Eco
      allow_grid_charging: false
      solar_production: 3000  # 13A total
      phase_a_consumption: 3.0
      phase_b_consumption: 3.0
      phase_c_consumption: 3.0
      battery_soc: 15  # Below minimum
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 6000
      inverter_max_power: 15000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 0  # Battery too low, Eco mode blocks charging
  
  # ===== BATTERY EDGE CASES =====
  
  - name: "3ph-1c-eco-battery-at-exact-min"
    description: "Battery SOC exactly at minimum threshold"
    site:
      voltage: 230
      main_breaker_rating: 25
      max_import_power: 17250
      num_phases: 3
      distribution_mode: priority
      charging_mode: Eco
      solar_production: 5000  # 22A total
      phase_a_consumption: 1.0
      phase_b_consumption: 1.0
      phase_c_consumption: 1.0
      battery_soc: 20  # Exactly at minimum
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 6000
      inverter_max_power: 15000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 6  # At minimum, should charge at min_current
  
  - name: "3ph-1c-solar-battery-at-exact-target"
    description: "Battery SOC exactly at target"
    site:
      voltage: 230
      main_breaker_rating: 25
      max_import_power: 17250
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 5000  # 22A total
      phase_a_consumption: 1.0
      phase_b_consumption: 1.0
      phase_c_consumption: 1.0
      battery_soc: 80  # Exactly at target
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 6000
      inverter_max_power: 15000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 6.3  # 22A - 3A = 19A / 3 = 6.3A (at target, not above, so no discharge)
  
  # ===== EXTREME CONSUMPTION =====
  
  - name: "3ph-1c-standard-heavy-importing"
    description: "Home consuming more than solar produces (importing)"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Standard
      solar_production: 3000  # 13A total
      phase_a_consumption: 8.0
      phase_b_consumption: 7.0
      phase_c_consumption: 6.0  # 21A total (importing 8A)
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 6000
      inverter_max_power: 15000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 32
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 32  # Standard mode allows grid import (24A breaker + 13A solar + 17A battery = 54A available / 3 = 18A per phase, but asymmetric so can use more)
  
  - name: "3ph-1c-solar-very-unbalanced"
    description: "One phase maxed out, others idle"
    site:
      voltage: 230
      main_breaker_rating: 25
      max_import_power: 17250
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 6900  # 30A total
      phase_a_consumption: 8.0  # Heavy load
      phase_b_consumption: 0.5
      phase_c_consumption: 0.5  # Light loads
      battery_soc: null
      battery_soc_min: null
      battery_soc_target: null
      battery_max_charge_power: null
      battery_max_discharge_power: null
      inverter_supports_asymmetric: false
      inverter_max_power_per_phase: 6000
      inverter_max_power: 15000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 2.0  # Limited by Phase A: 10A - 8A = 2A (below min, so 0A) - actually wait, this would be 2A
  
  # ===== CHARGER CONFIG EDGE CASES =====
  
  - name: "3ph-1c-solar-fixed-current-charger"
    description: "Charger with min_current = max_current (no variability)"
    site:
      voltage: 230
      main_breaker_rating: 25
      max_import_power: 17250
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 8000  # 35A total
      phase_a_consumption: 1.0
      phase_b_consumption: 1.0
      phase_c_consumption: 1.0
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 6000
      inverter_max_power: 15000
    chargers:
      - entity_id: "charger_1"
        min_current: 16
        max_current: 16  # Fixed at 16A
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 16  # Can only do 16A or nothing
  
  - name: "3ph-2c-solar-wide-range-chargers"
    description: "Mix of chargers with different capabilities"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 15000  # 65A total
      phase_a_consumption: 1.0
      phase_b_consumption: 1.0
      phase_c_consumption: 1.0
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 5000
      battery_max_discharge_power: 5000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 8000
      inverter_max_power: 20000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 32  # Wide range
        phases: 3
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16  # Standard range
        phases: 3
        priority: 2
    expected:
      charger_1:
        target: 20.7  # Gets most of available
      charger_2:
        target: 0  # Not enough left after charger_1
  
  # ===== MULTI-CHARGER PRIORITY EDGE CASES =====
  
  - name: "3ph-4c-solar-many-chargers"
    description: "Four chargers competing for limited power"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 12000  # 52A total
      phase_a_consumption: 1.0
      phase_b_consumption: 1.0
      phase_c_consumption: 1.0
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 8000
      inverter_max_power: 20000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 2
      - entity_id: "charger_3"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 3
      - entity_id: "charger_4"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 4
    expected:
      charger_1:
        target: 16  # Gets max
      charger_2:
        target: 0.3  # Gets tiny amount (49A - 48A = 1A = 0.33A/phase)
      charger_3:
        target: 0
      charger_4:
        target: 0
  
  - name: "3ph-2c-solar-same-priority"
    description: "Two chargers with identical priority"
    site:
      voltage: 230
      main_breaker_rating: 25
      max_import_power: 17250
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 8000  # 35A total
      phase_a_consumption: 1.0
      phase_b_consumption: 1.0
      phase_c_consumption: 1.0
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 6000
      inverter_max_power: 15000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1  # Same priority
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1  # Same priority
    expected:
      charger_1:
        target: 6  # Both get minimum first
      charger_2:
        target: 6  # Then split remainder (32A total, 36A needed for both min)
  
  # ===== ZERO/NULL VALUE HANDLING =====
  
  - name: "3ph-1c-standard-zero-solar-night"
    description: "Night time charging with no solar"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Standard
      solar_production: 0  # No solar
      phase_a_consumption: 2.0
      phase_b_consumption: 2.0
      phase_c_consumption: 2.0
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 6000
      inverter_max_power: 15000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 32
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 27.3  # Grid only: (32A - 2A) * 3 + 17.4A battery = 107.4A / 3 = ~35.8A but let's calculate properly
  
  - name: "3ph-1c-eco-zero-solar-night"
    description: "Eco mode at night should use minimum only"
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Eco
      solar_production: 0  # No solar
      phase_a_consumption: 2.0
      phase_b_consumption: 2.0
      phase_c_consumption: 2.0
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 6000
      inverter_max_power: 15000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 32
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 6  # Eco with battery above target but no solar: use battery discharge (17.4A available) which is > min
  
  # ===== REAL-WORLD SCENARIOS =====
  
  - name: "3ph-2c-solar-morning-ramp-up"
    description: "Solar increasing during charge (multi-iteration)"
    iterations: 3
    max_variation: 1.0
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 3000  # Starts low, will increase
      phase_a_consumption: 1.5
      phase_b_consumption: 1.5
      phase_c_consumption: 1.5
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 8000
      inverter_max_power: 20000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
      - entity_id: "charger_2"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 2
    expected:
      charger_1:
        target: 6  # Eventually stabilizes
      charger_2:
        target: 0
  
  - name: "3ph-1c-solar-cloud-passing"
    description: "Solar dropping suddenly (oscillation test)"
    iterations: 3
    max_variation: 0.5
    site:
      voltage: 230
      main_breaker_rating: 32
      max_import_power: 22080
      num_phases: 3
      distribution_mode: priority
      charging_mode: Solar
      solar_production: 12000  # Starts high
      phase_a_consumption: 2.0
      phase_b_consumption: 2.0
      phase_c_consumption: 2.0
      battery_soc: 85
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4000
      battery_max_discharge_power: 4000
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 8000
      inverter_max_power: 20000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
    expected:
      charger_1:
        target: 16  # Should stabilize at available
