# Test scenarios: Solar mode, single-phase sites, with battery

scenarios:

  - name: "1ph-1c-solar-prio-with-bat-bellow-target"
    description: "Single phase, 1 charger, solar mode, with battery, normal conditions"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050

      distribution_mode: priority
      solar_production: 4140  # 18A at 230V
      phase_a_consumption: 3.0  # Home load before EVSE

      battery_soc: 75
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4600  # 20A at 230V
      battery_max_discharge_power: 4600  # 20A at 230V
      inverter_supports_asymmetric: True
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 32
        phases: 1
        priority: 1
    expected: # Manually verified expected result
      charger_1:
        allocated: 0  # battery not at target SOC, so no charging (18A solar - 3A load = 15A charging, but solar mode with battery below target prevents use)

  - name: "1ph-1c-solar-prio-with-bat-at-target"
    description: "Single phase, 1 charger, solar mode, with battery, normal conditions"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050

      distribution_mode: priority
      solar_production: 4140  # 18A at 230V
      phase_a_consumption: 3.0  # Home load before EVSE

      battery_soc: 80
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4600  # 20A at 230V
      battery_max_discharge_power: 4600  # 20A at 230V
      inverter_supports_asymmetric: True
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 32
        phases: 1
        priority: 1
    expected: # Manually verified expected result
      charger_1:
        allocated: 15.0  # 18A solar - 3A consumption

  - name: "1ph-1c-solar-prio-with-bat-above-target"
    description: "Single phase, 1 charger, solar mode, with battery, normal conditions"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050

      distribution_mode: priority
      solar_production: 2300  # 10A at 230V
      phase_a_consumption: 3.0  # Home load before EVSE

      battery_soc: 90
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4600  # 20A at 230V
      battery_max_discharge_power: 4600  # 20A at 230V
      inverter_supports_asymmetric: True
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 32
        phases: 1
        priority: 1
    expected: # Manually verified expected result
      charger_1:
        allocated: 27.0  # 10A solar + 20A from battery - 3A consumption

  - name: "1ph-2c-solar-prio-with-bat-shared"
    description: "Single phase, 2 chargers both solar, verify no double counting"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050

      distribution_mode: priority
      solar_production: 5290  # 23A at 230V
      phase_a_consumption: 3.0  # Home load

      battery_soc: 80
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4140
      battery_max_discharge_power: 4140
      inverter_supports_asymmetric: True
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 1
      - entity_id: "charger_2"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 2
    expected:  # Manually verified expected result
      charger_1:
        allocated: 14  # 20A is available after load, That is enough for both chargers to charge. After minimum charge rate is met for both chargers, the remaining 8 goes to the gihewr priority one.
      charger_2:
        allocated: 6

  - name: "1ph-2c-solar-prio-with-bat-shared-low-solar"
    description: "Single phase, 2 chargers both solar, verify no double counting"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050

      distribution_mode: priority
      solar_production: 2300  # 10A at 230V
      phase_a_consumption: 3.0  # Home load

      battery_soc: 80
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4140
      battery_max_discharge_power: 4140
      inverter_supports_asymmetric: True
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 1
      - entity_id: "charger_2"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 2
    expected:  # Manually verified expected result
      charger_1:
        allocated: 7  # Not enough is available for both to charge at minimum, so higher priority charger gets all 7A available after load
      charger_2:
        allocated: 0

  - name: "1ph-2c-solar-shared-with-bat-shared-low-solar"
    description: "Single phase, 2 chargers both solar, verify no double counting"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050

      distribution_mode: Shared
      solar_production: 2300  # 10A at 230V
      phase_a_consumption: 3.0  # Home load

      battery_soc: 80
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4140
      battery_max_discharge_power: 4140
      inverter_supports_asymmetric: True
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 1
      - entity_id: "charger_2"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 2
    expected:  # Manually verified expected result
      charger_1:
        allocated: 7  # Not enough is available for both to charge at minimum, so higher priority charger gets all 7A available after load
      charger_2:
        allocated: 0

  - name: "1ph-2c-solar-prio-with-bat-shared-high-solar"
    description: "Single phase, 2 chargers both solar, verify no double counting"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050

      distribution_mode: priority
      solar_production: 6900  # 30A at 230V
      phase_a_consumption: 3.0  # Home load

      battery_soc: 80
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4140
      battery_max_discharge_power: 4140
      inverter_supports_asymmetric: True
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 1
      - entity_id: "charger_2"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 2
    expected:  # Manually verified expected result
      charger_1:
        allocated: 16 # Maxes out at 16A, even though more is available
      charger_2:
        allocated: 11 # 30A - 3A load - 16A to charger_1

  - name: "1ph-2c-solar-shared-with-bat-shared-high-solar"
    description: "Single phase, 2 chargers both solar, verify no double counting"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050

      distribution_mode: Shared
      solar_production: 6900  # 30A at 230V
      phase_a_consumption: 3.0  # Home load

      battery_soc: 80
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4140
      battery_max_discharge_power: 4140
      inverter_supports_asymmetric: True
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 1
      - entity_id: "charger_2"
        operating_mode: "Solar Only"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 2
    expected:  # Manually verified expected result
      charger_1:
        allocated: 13.5 # shared evenly
      charger_2:
        allocated: 13.5
