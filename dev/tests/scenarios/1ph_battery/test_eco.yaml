# Test scenarios: Eco mode, single-phase sites, with battery

scenarios:

  - name: "1ph-1c-eco-bat-above-target"
    description: "Eco with battery above target — uses solar surplus + battery discharge"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050
      distribution_mode: priority
      charging_mode: Eco
      solar_production: 2300  # 10A at 230V
      phase_a_consumption: 3.0
      battery_soc: 90
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4600  # 20A
      battery_max_discharge_power: 4600  # 20A
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 32
        phases: 1
        priority: 1
    expected:
      charger_1:
        allocated: 27.0  # Solar 10A + battery 20A - consumption 3A = 27A. Eco above target = max(surplus, min).

  - name: "1ph-1c-eco-bat-below-min"
    description: "Eco with battery below minimum SOC — no charging"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050
      distribution_mode: priority
      charging_mode: Eco
      solar_production: 3450  # 15A
      phase_a_consumption: 2.0
      battery_soc: 15  # Below 20% min
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4600
      battery_max_discharge_power: 4600
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 1
    expected:
      charger_1:
        allocated: 0.0  # Battery below min → Eco blocks all charging

  - name: "1ph-1c-eco-bat-between-min-target"
    description: "Eco with battery between min and target — minimum current only"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050
      distribution_mode: priority
      charging_mode: Eco
      solar_production: 4140  # 18A
      phase_a_consumption: 2.0
      battery_soc: 50  # Between 20% min and 80% target
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4600
      battery_max_discharge_power: 4600
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 1
    expected:
      charger_1:
        allocated: 6.0  # Battery between min and target → Eco only allows minimum current

  - name: "1ph-1c-eco-bat-at-target-good-solar"
    description: "Eco with battery at target and good solar — surplus allocation"
    human_verified: false
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050
      distribution_mode: priority
      charging_mode: Eco
      solar_production: 4140  # 18A
      phase_a_consumption: 3.0
      battery_soc: 80  # At target
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 4600
      battery_max_discharge_power: 4600
      inverter_supports_asymmetric: true
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 1
    expected:
      charger_1:
        allocated: 15.0  # 18A solar - 3A consumption = 15A surplus. Eco: max(15, 6) = 15A.
