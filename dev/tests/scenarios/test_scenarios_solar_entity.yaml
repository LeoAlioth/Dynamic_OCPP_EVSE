# Test scenarios: Direct solar production entity
# Tests the solar_production_direct flag where solar is read from a dedicated sensor
# instead of being derived from consumption + export.

scenarios:

  - name: "solar-entity-1ph-basic"
    description: "1-phase, direct solar entity matches derived value - same result expected"
    human_verified: True
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050
      distribution_mode: priority
      charging_mode: Solar

      # Direct solar entity: 3000W
      solar_production: 3000
      solar_production_direct: true

      # Grid meter shows 2A consumption and ~11A export (solar - consumption)
      phase_a_consumption: 2.0
      phase_a_export: 11.0  # (3000W / 230V) - 2A = ~11A

      battery_soc: null
      battery_soc_min: null
      battery_soc_target: null
      battery_max_charge_power: null
      battery_max_discharge_power: null
      inverter_supports_asymmetric: false
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 1
    expected:
      charger_1:
        allocated: 11.0  # 11A export available for solar charging

  - name: "solar-entity-3ph-with-battery"
    description: "3-phase, direct solar entity with battery, Solar mode, battery below target"
    human_verified: True
    site:
      voltage: 230
      main_breaker_rating: 63
      max_import_power: 14490
      distribution_mode: priority
      charging_mode: Solar

      # Direct solar entity: 8000W
      solar_production: 8000
      solar_production_direct: true

      # Grid meter: 3A consumption per phase, exporting ~8.6A per phase
      # solar_per_phase = 8000 / 3 / 230 = 11.6A
      # export = 11.6 - 3.0 = 8.6A per phase
      phase_a_consumption: 3.0
      phase_b_consumption: 3.0
      phase_c_consumption: 3.0
      phase_a_export: 8.6
      phase_b_export: 8.6
      phase_c_export: 8.6

      battery_soc: 50
      battery_soc_min: 20
      battery_soc_target: 80
      battery_max_charge_power: 5000
      battery_max_discharge_power: 5000
      inverter_supports_asymmetric: false
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 3
        priority: 1
    expected:
      charger_1:
        allocated: 0.0  # Battery below target in Solar mode — no EV charging

  - name: "solar-entity-overrides-derived"
    description: "Direct solar entity (2000W) differs from derived value (1150W). Verifies engine uses direct value."
    human_verified: True
    site:
      voltage: 230
      main_breaker_rating: 35
      max_import_power: 8050
      distribution_mode: priority
      charging_mode: Solar

      # Direct solar entity: 2000W (from inverter-side meter)
      # Grid meter shows 2A consumption, 3A export → derived would be (2+3)*230 = 1150W
      # With derived 1150W: solar_per_phase = 1150/230 = 5A, available = 5-2 = 3A → below 6A min → 0A
      # With direct 2000W: solar_per_phase = 2000/230 = 8.7A, available = 8.7-2 = 6.7A → charger gets 6.7A
      solar_production: 2000
      solar_production_direct: true

      phase_a_consumption: 2.0
      phase_a_export: 3.0

      battery_soc: null
      battery_soc_min: null
      battery_soc_target: null
      battery_max_charge_power: null
      battery_max_discharge_power: null
      inverter_supports_asymmetric: false
      inverter_max_power_per_phase: 12000
      inverter_max_power: 12000
    chargers:
      - entity_id: "charger_1"
        min_current: 6
        max_current: 16
        phases: 1
        priority: 1
    expected:
      charger_1:
        allocated: 6.7  # 2000W/230V - 2A consumption = 6.7A (derived would give 0A)
